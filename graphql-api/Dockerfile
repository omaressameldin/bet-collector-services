ARG WORKDIR=/usr/src/app/api
FROM gradle
ARG WORKDIR
ARG PROTO_DIR


WORKDIR $WORKDIR

COPY ./graphql-api/api/. ./.
COPY ./graphql-api/grpc/. ./grpc/.
COPY $PROTO_DIR/**/* ./grpc/src/main/proto/
RUN gradle && gradle wrapper && ./gradlew build --no-daemon


FROM openjdk:13-alpine
ARG WORKDIR
ARG APPNAME=app.jar
ENV APPNAME $APPNAME
ARG USER_GRPC_SERVICE
ENV USER_GRPC_SERVICE $USER_GRPC_SERVICE
ARG USER_GRPC_SERVICE_PORT
ENV USER_GRPC_SERVICE_PORT $USER_GRPC_SERVICE_PORT
ARG BET_GRPC_SERVICE
ENV BET_GRPC_SERVICE $BET_GRPC_SERVICE
ARG BET_GRPC_SERVICE_PORT
ENV BET_GRPC_SERVICE_PORT $BET_GRPC_SERVICE_PORT
ARG GRAPHQL_API_PORT
ENV GRAPHQL_API_PORT $GRAPHQL_API_PORT

COPY --from=0 $WORKDIR/build/libs/*.jar ./$APPNAME
EXPOSE $GRAPHQL_API_PORT

CMD java -XX:+UnlockExperimentalVMOptions -Djava.security.egd=file:/dev/./urandom -jar $APPNAME
